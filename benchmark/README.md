# ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (Performance Tests)

ì´ ë””ë ‰í† ë¦¬ëŠ” ì‹œìŠ¤í…œ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
tests/performance/
â”œâ”€â”€ README.md                           # ì´ íŒŒì¼
â”œâ”€â”€ test_redis_performance.py           # Redis ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ â­ NEW
â””â”€â”€ test_batch_collection_performance.py # ë°°ì¹˜ ìˆ˜ì§‘ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
```

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### Redis ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

```bash
# ì „ì²´ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ (ì•½ 30ì´ˆ)
python tests/performance/test_redis_performance.py

# pytestë¡œ ì‹¤í–‰
pytest tests/performance/test_redis_performance.py -v -s

# ê°œë³„ í…ŒìŠ¤íŠ¸
pytest tests/performance/test_redis_performance.py::test_state_update_latency -v
```

### ë°°ì¹˜ ìˆ˜ì§‘ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```bash
python tests/performance/test_batch_collection_performance.py
```

---

## ğŸ“Š Redis ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

### í…ŒìŠ¤íŠ¸ í•­ëª©

| í…ŒìŠ¤íŠ¸ | ëª©í‘œ | ì„¤ëª… |
|--------|------|------|
| **ìƒíƒœ ê°±ì‹  ì§€ì—°ì‹œê°„** | P99 < 15ms | 1,000 ë™ì‹œ ì—°ê²° ìƒíƒœ ê°±ì‹  |
| **Lua ìŠ¤í¬ë¦½íŠ¸ ì²˜ë¦¬ëŸ‰** | >= 5,000 ops/sec | ì‹¬ë³¼ êµì²´ Lua ìŠ¤í¬ë¦½íŠ¸ |
| **TTL ì •í™•ì„±** | Â±1ì´ˆ ì´ë‚´ 99% | Redis TTL ë§Œë£Œ ì •í™•ë„ |

### ì‹¤í–‰ ì˜ˆì‹œ

```bash
$ python tests/performance/test_redis_performance.py

================================================================================
Redis ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹œì‘
================================================================================

================================================================================
í…ŒìŠ¤íŠ¸ 1: ìƒíƒœ ê°±ì‹  ì§€ì—°ì‹œê°„ (ëª©í‘œ: P99 < 15ms)
================================================================================
ë™ì‹œ ì—°ê²° ìˆ˜: 1,000
âœ“ 1,000ê°œ ì—°ê²° ì´ˆê¸°í™” ì™„ë£Œ
â±ï¸  ìƒíƒœ ê°±ì‹  ì¤‘...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š ê²°ê³¼:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´ ì—°ì‚° ìˆ˜:      1,000
ì´ ì†Œìš” ì‹œê°„:    0.85ì´ˆ
ì²˜ë¦¬ëŸ‰:          1,176 ops/sec

ì§€ì—°ì‹œê°„ (ms):
  P50:           8.23 ms
  P95:           12.45 ms
  P99:           14.12 ms âœ…
  Max:           16.78 ms
  Min:           5.12 ms
  Avg:           8.67 ms

âœ… ëª©í‘œ ë‹¬ì„±: P99 14.12ms < 15ms

================================================================================
í…ŒìŠ¤íŠ¸ 2: Lua ìŠ¤í¬ë¦½íŠ¸ ì²˜ë¦¬ëŸ‰ (ëª©í‘œ: 5,000+ ops/sec)
================================================================================
ì—°ì‚° íšŸìˆ˜: 10,000
âœ“ ì´ˆê¸° ìƒíƒœ ì„¤ì • ì™„ë£Œ
â±ï¸  Lua ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘...
  ì§„í–‰ë¥ : 10% (1,000/10,000)
  ...
  ì§„í–‰ë¥ : 100% (10,000/10,000)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š ê²°ê³¼:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´ ì—°ì‚° ìˆ˜:      10,000
ì´ ì†Œìš” ì‹œê°„:    1.25ì´ˆ
ì²˜ë¦¬ëŸ‰:          8,000 ops/sec âœ…

ì§€ì—°ì‹œê°„ (ms):
  P50:           0.12 ms
  P95:           0.25 ms
  P99:           0.45 ms
  ...

âœ… ëª©í‘œ ë‹¬ì„±: 8,000 ops/sec >= 5,000

================================================================================
ğŸ“‹ ì¢…í•© ë¦¬í¬íŠ¸
================================================================================

1ï¸âƒ£  ìƒíƒœ ê°±ì‹  ì§€ì—°ì‹œê°„: âœ… PASS
   - P99: 14.12ms (ëª©í‘œ: < 15ms)
   - ì²˜ë¦¬ëŸ‰: 1,176 ops/sec

2ï¸âƒ£  Lua ìŠ¤í¬ë¦½íŠ¸ ì²˜ë¦¬ëŸ‰: âœ… PASS
   - ì²˜ë¦¬ëŸ‰: 8,000 ops/sec (ëª©í‘œ: >= 5,000)
   - P99: 0.45ms

3ï¸âƒ£  TTL ì •í™•ì„±: âœ… PASS
   - Â±1ì´ˆ ì´ë‚´: 99.5% (ëª©í‘œ: >= 99%)
   - í‰ê·  ì˜¤ì°¨: 0.3ì´ˆ

================================================================================
âœ… ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ
================================================================================
```

### pytest í†µí•©

```bash
# ëª¨ë“  ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest tests/performance/ -v

# Redis ì„±ëŠ¥ë§Œ
pytest tests/performance/test_redis_performance.py -v

# ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
pytest tests/performance/test_redis_performance.py -x

# ë³‘ë ¬ ì‹¤í–‰ (pytest-xdist)
pytest tests/performance/ -n 2
```

---

## ğŸ”§ ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•

### ë²¤ì¹˜ë§ˆí¬ íŒŒë¼ë¯¸í„° ì¡°ì •

```python
# tests/performance/test_redis_performance.py ìˆ˜ì •

# ì—°ê²° ìˆ˜ ì¡°ì •
await benchmark_state_update_latency(num_connections=500)  # ê¸°ë³¸: 1000

# ì—°ì‚° íšŸìˆ˜ ì¡°ì •
await benchmark_lua_script_throughput(num_operations=5000)  # ê¸°ë³¸: 10000

# ìƒ˜í”Œ ìˆ˜ ì¡°ì •
await benchmark_ttl_accuracy(num_samples=50)  # ê¸°ë³¸: 100
```

### CI/CD í†µí•©

```yaml
# .github/workflows/performance.yml
name: Performance Tests

on:
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/infra/cache/**'
      - 'tests/performance/**'

jobs:
  redis-performance:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Run Redis benchmarks
        run: |
          pytest tests/performance/test_redis_performance.py -v
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: test-results/
```

---

## ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### ëŸ°íƒ€ì„ ëª¨ë‹ˆí„°ë§

ë²¤ì¹˜ë§ˆí¬ ì™¸ì— ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤:

```python
from src.infra.cache.performance_monitor import get_redis_monitor

# ì‹±ê¸€í†¤ ëª¨ë‹ˆí„°
monitor = get_redis_monitor(window_size=10000, log_interval=60)

# ì—°ì‚° ì¶”ì 
async with monitor.track("update_connection_state"):
    await cache.update_connection_state(status, ttl)

# í†µê³„ ì¡°íšŒ
stats = monitor.get_stats("update_connection_state")
print(f"P99: {stats.p99:.2f}ms")
```

ìì„¸í•œ ë‚´ìš©ì€ [`docs/REDIS_PERFORMANCE.md`](../../docs/REDIS_PERFORMANCE.md) ì°¸ê³ .

---

## ğŸ› ë¬¸ì œ í•´ê²°

### 1. "Connection refused" ì—ëŸ¬

```bash
# Redisê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
redis-cli ping
# PONG ì‘ë‹µì´ ì™€ì•¼ í•¨

# Dockerë¡œ Redis ì‹¤í–‰
docker run -d -p 6379:6379 redis:7-alpine
```

### 2. í…ŒìŠ¤íŠ¸ê°€ ëŠë¦½ë‹ˆë‹¤

```python
# í…ŒìŠ¤íŠ¸ íŒŒë¼ë¯¸í„°ë¥¼ ì¤„ì—¬ë³´ì„¸ìš”
await benchmark_state_update_latency(num_connections=100)  # 1000 â†’ 100
await benchmark_lua_script_throughput(num_operations=1000)  # 10000 â†’ 1000
```

### 3. P99 ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í•©ë‹ˆë‹¤

**ì›ì¸**:
- ë„¤íŠ¸ì›Œí¬ ì§€ì—° (Docker, ì›ê²© Redis)
- Redis ì„œë²„ ë¶€í•˜
- ë™ì‹œ ì‹¤í–‰ ì¤‘ì¸ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤

**í•´ê²°**:
```bash
# 1. ë¡œì»¬ Redis ì‚¬ìš©
redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru

# 2. Redis ì„¤ì • ìµœì í™”
redis-cli CONFIG SET save ""  # RDB ì €ì¥ ë¹„í™œì„±í™” (í…ŒìŠ¤íŠ¸ìš©)

# 3. ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›„ ì¬ì‹¤í–‰
```

### 4. ë©”ëª¨ë¦¬ ë¶€ì¡±

```bash
# ë²¤ì¹˜ë§ˆí¬ ì¤‘ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
docker stats redis

# Redis ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •
redis-cli CONFIG SET maxmemory 512mb
```

---

## ğŸ“š ì¶”ê°€ ìë£Œ

### ê´€ë ¨ ë¬¸ì„œ

- [Redis ì„±ëŠ¥ ê°€ì´ë“œ](../../docs/REDIS_PERFORMANCE.md) - ì „ì²´ ê°€ì´ë“œ
- [ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì˜ˆì œ](../../examples/redis_performance_example.py) - ì‹¤ì „ ì˜ˆì œ
- [ìºì‹œ ìŠ¤í† ì–´](../../src/infra/cache/cache_store.py) - ì‹¤ì œ êµ¬í˜„

### ì™¸ë¶€ ì°¸ê³ 

- [Redis Benchmarks](https://redis.io/docs/management/optimization/benchmarks/)
- [Redis Latency](https://redis.io/docs/management/optimization/latency/)
- [Lua Scripting](https://redis.io/docs/manual/programmability/eval-intro/)

---

## ğŸ¯ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì‹œì 

- âœ… **ë¡œì»¬ ê°œë°œ**: ì½”ë“œ ë³€ê²½ í›„ ìˆ˜ì‹œ ì‹¤í–‰
- âœ… **PR ì „**: ì„±ëŠ¥ íšŒê·€ í™•ì¸
- âœ… **ì£¼ê¸°ì **: CI/CDì—ì„œ ë§¤ì£¼ ì‹¤í–‰
- âŒ **í”„ë¡œë•ì…˜**: ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì‹¤í–‰í•˜ì§€ ë§ ê²ƒ

### 2. ê²°ê³¼ í•´ì„

- **P99 < 15ms**: âœ… ì–‘í˜¸
- **P99 15-20ms**: âš ï¸ ì£¼ì˜ (ë„¤íŠ¸ì›Œí¬ í™•ì¸)
- **P99 > 20ms**: âŒ ê°œì„  í•„ìš”

### 3. ëª¨ë‹ˆí„°ë§ ì „ëµ

```python
# ê°œë°œ í™˜ê²½: í™œì„±í™”
monitor = get_redis_monitor()

# í”„ë¡œë•ì…˜: ìƒ˜í”Œë§ ë˜ëŠ” ë¹„í™œì„±í™”
if os.getenv("ENV") == "production":
    monitor.disable()
```

### 4. ì„±ëŠ¥ ìµœì í™” ìˆœì„œ

1. **ì¸¡ì •**: ë²¤ì¹˜ë§ˆí¬ë¡œ í˜„ì¬ ì„±ëŠ¥ í™•ì¸
2. **ë³‘ëª©ì  íŒŒì•…**: ì–´ë–¤ ì—°ì‚°ì´ ëŠë¦°ì§€ í™•ì¸
3. **ìµœì í™”**: ì½”ë“œ ê°œì„  (Pipeline, Lua ìŠ¤í¬ë¦½íŠ¸ ë“±)
4. **ì¬ì¸¡ì •**: ê°œì„  íš¨ê³¼ í™•ì¸
5. **ë°˜ë³µ**: ëª©í‘œ ë‹¬ì„±ê¹Œì§€

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „:

- [ ] Redisê°€ ì‹¤í–‰ ì¤‘ì¸ê°€?
- [ ] ë‹¤ë¥¸ ë¶€í•˜ê°€ ì—†ëŠ” í™˜ê²½ì¸ê°€?
- [ ] ì¶©ë¶„í•œ ë©”ëª¨ë¦¬ê°€ ìˆëŠ”ê°€? (ìµœì†Œ 2GB)
- [ ] ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ ì ì€ê°€?

í…ŒìŠ¤íŠ¸ í›„:

- [ ] ëª¨ë“  ëª©í‘œë¥¼ ë‹¬ì„±í–ˆëŠ”ê°€?
- [ ] ê²°ê³¼ë¥¼ ê¸°ë¡í–ˆëŠ”ê°€?
- [ ] ì„±ëŠ¥ íšŒê·€ê°€ ì—†ëŠ”ê°€?
- [ ] ë¬¸ì œê°€ ìˆë‹¤ë©´ í•´ê²°í–ˆëŠ”ê°€?

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-14  
**ê´€ë¦¬ì**: DevOps Team
